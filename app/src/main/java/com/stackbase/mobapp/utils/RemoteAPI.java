package com.stackbase.mobapp.utils;import android.content.SharedPreferences;import android.preference.PreferenceManager;import android.util.Log;import com.stackbase.mobapp.ApplicationContextProvider;import com.stackbase.mobapp.R;import com.stackbase.mobapp.objects.Borrower;import com.stackbase.mobapp.objects.LoginBean;import com.stackbase.mobapp.objects.SIMCardInfo;import org.json.simple.JSONArray;import org.json.simple.JSONObject;import org.json.simple.parser.JSONParser;import java.io.File;import java.io.IOException;import java.net.HttpURLConnection;import java.util.ArrayList;import java.util.HashMap;import java.util.List;import java.util.Map;public class RemoteAPI {    private String apiEndpoint;    private String token;    private static final String TAG = RemoteAPI.class.getName();    public RemoteAPI() {        SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(ApplicationContextProvider.getContext());        apiEndpoint = prefs.getString(Constant.KEY_REMOTE_API_ENDPOINT, Constant.DEFAULT_API_ENDPOINT);        token = prefs.getString(Constant.KEY_REMOTE_ACCESS_TOKEN, "1826");    }    public LoginBean login(String username, String pass, SIMCardInfo phoneInfo) throws IOException {        String action = "app/doLogin.action";        String url = String.format("%s/%s?userName=%s&password=%s&telePhone=%s&checkUnique=true&deviceId=%s",                apiEndpoint, action, username, pass, phoneInfo.getNativePhoneNumber(), phoneInfo.getDeviceID());        try {            String response = HTTPUtils.get(url);            Log.d(TAG, "response: " + response);            int status = 500;            try {                JSONParser parser = new JSONParser();                Object obj = parser.parse(response);                JSONObject jsonObject = (JSONObject) obj;                if (jsonObject.get("retCode") != null) {                    Object data = jsonObject.get("data");                    LoginBean bean = new LoginBean(((JSONObject)data).toJSONString());                    bean.setTip((String)jsonObject.get("tip"));                    return bean;                } else {                    Log.d(TAG, "Can not get the retCode!!");                    throw new Exception("");                }            } catch (Exception e) {                Log.e(TAG, "Fail to parse result.", e);//                status = HttpURLConnection.HTTP_BAD_REQUEST;                throw new RemoteException(status,                        ApplicationContextProvider.getContext().getString(R.string.call_api_failed, status));            }        } catch (IOException e) {            throw e;        }    }    public String uploadUserDatum(File jpg, int datumId, int borrowId) throws IOException {        String action = "app/uploadUserDatum.action";        String url = String.format("%s/%s", apiEndpoint, action);        String response = "";        try {            Map<String, String> params = new HashMap<>();            params.put("imageName", jpg.getName());            params.put("datumId", (Integer.valueOf(datumId)).toString());            params.put("borrowId", (Integer.valueOf(borrowId)).toString());            params.put("imgSize", (Long.valueOf(jpg.length())).toString());            params.put("encryptpwd", token);            response = HTTPUtils.post(url, params, null, jpg);        } catch (IOException e) {            Log.e(TAG, "Fail to upload user datum.", e);            throw e;        }        return response;    }    public List<Borrower> listBorrowers() throws IOException {        String action = "app/borrowAllUserInfo.action";        List<Borrower> result = new ArrayList<>();        try {//            Map<String, String> headers = new HashMap<>();//            headers.put("Content-Type", "application/json");//            headers.put("Accept", "application/json");//            String body = "{\"authaa\": {\"tenantName\": \"admin\", \"passwordCredentials\": {\"username\": \"admin\", \"password\": \"1be775ea0ff34d07\"}}}";//            result = HTTPUtils.post("http://158.85.90.245:5000/v2.0/tokens", body, headers);            String url = String.format("%s/%s?encryptpwd=%s", apiEndpoint, action, token);            Log.d(TAG, "Access url: " + url);            String response = HTTPUtils.get(url);//            String response = testList;            Log.d(TAG, response);            int status = 200;            try {                JSONParser parser = new JSONParser();                Object obj = parser.parse(response);                JSONObject jsonObject = (JSONObject) obj;                if (jsonObject.get("msgNum") != null) {                    status = ((Long)jsonObject.get("msgNum")).intValue();                }                Object dataList = jsonObject.get("data");                if (dataList != null && dataList instanceof JSONArray) {                    for (Object data: ((JSONArray) dataList).toArray()) {                        JSONObject jd = (JSONObject)data;                        String id = (String) jd.get("idcard");                        String name = (String) jd.get("realname");                        if (id == null || id.equals("") || name == null || name.equals("")) {                            Log.d(TAG, "id or name is empty, it's invalid data, skip it!!");                            continue;                        }                        Borrower borrower = new Borrower();                        borrower.fromJSONStr(jd.toJSONString());                        borrower.setBorrowId(((Long) jd.get("id")).intValue());                        borrower.setBorrowType(((Long) jd.get("borrowtype")).intValue());                        borrower.setBorrowTypeDesc((String) jd.get("title"));                        borrower.setId((String) jd.get("idcard"));                        borrower.setName((String) jd.get("realname"));                        Helper.saveBorrower(borrower);                        result.add(borrower);                    }                } else {                    throw new RemoteException(status,                            ApplicationContextProvider.getContext().getString(R.string.call_api_failed, status));                }            } catch (Exception e) {                Log.e(TAG, "Fail to parse result.", e);                status = HttpURLConnection.HTTP_BAD_REQUEST;                throw new RemoteException(status,                        ApplicationContextProvider.getContext().getString(R.string.call_api_failed, status));            }        } catch (IOException e) {            Log.e(TAG, "Fail to list borrowers.", e);            throw e;        }        return result;    }    private static final String testList = "\n" +            "\n" +            "    {\n" +            "       \"data\":\n" +            "       [\n" +            "           {\n" +            "               \"borrowtype\": 1,\n" +            "               \"datalist\":\n" +            "               [\n" +            "                   {\n" +            "                       \"datumId\": 17,\n" +            "                       \"datumName\": \"央行征信报告\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 6,\n" +            "                       \"datumName\": \"驾照\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 8,\n" +            "                       \"datumName\": \"行驶证\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 10,\n" +            "                       \"datumName\": \"个人社保\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 12,\n" +            "                       \"datumName\": \"非工资卡银行近3个月流水\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 14,\n" +            "                       \"datumName\": \"营业执照\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 23,\n" +            "                       \"datumName\": \"学历证明\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 24,\n" +            "                       \"datumName\": \"职工社保\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 25,\n" +            "                       \"datumName\": \"农村医疗保险\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 27,\n" +            "                       \"datumName\": \"水电煤气费\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 33,\n" +            "                       \"datumName\": \"机动车登记证\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 34,\n" +            "                       \"datumName\": \"对公账户银行流水\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 35,\n" +            "                       \"datumName\": \"道路运输证\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 38,\n" +            "                       \"datumName\": \"项目承包合同\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 79,\n" +            "                       \"datumName\": \"电子借条\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 1,\n" +            "                       \"datumName\": \"本人身份证\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 2,\n" +            "                       \"datumName\": \"家属身份证\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 3,\n" +            "                       \"datumName\": \"户口本\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 4,\n" +            "                       \"datumName\": \"结婚证\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 5,\n" +            "                       \"datumName\": \"与直系亲属合影照\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 11,\n" +            "                       \"datumName\": \"工资卡银行近3个月流水\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 13,\n" +            "                       \"datumName\": \"现就职单位劳动合同\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 15,\n" +            "                       \"datumName\": \"固定电话近3个月详单\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 18,\n" +            "                       \"datumName\": \"住处相关照片\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 19,\n" +            "                       \"datumName\": \"其它证明\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 21,\n" +            "                       \"datumName\": \"婚姻证明\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 31,\n" +            "                       \"datumName\": \"收入证明\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 45,\n" +            "                       \"datumName\": \"房产证明\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 50,\n" +            "                       \"datumName\": \"家访记录\"\n" +            "                   }\n" +            "               ],\n" +            "               \"id\": 91011,\n" +            "               \"idcard\": \"520113197912294787\",\n" +            "               \"realname\": \"密码二\",\n" +            "               \"title\": \"测试上传图...\"\n" +            "           },\n" +            "           {\n" +            "               \"borrowtype\": 1,\n" +            "               \"datalist\":\n" +            "               [\n" +            "                   {\n" +            "                       \"datumId\": 3,\n" +            "                       \"datumName\": \"户口本\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 4,\n" +            "                       \"datumName\": \"结婚证\"\n" +            "                   }\n" +            "               ],\n" +            "               \"id\": 90954,\n" +            "               \"idcard\": \"130631198811162023\",\n" +            "               \"realname\": \"刘京\",\n" +            "               \"title\": \"测试数据使...\"\n" +            "           },\n" +            "           {\n" +            "               \"borrowtype\": 1,\n" +            "               \"datalist\":\n" +            "               [\n" +            "                   {\n" +            "                       \"datumId\": 17,\n" +            "                       \"datumName\": \"央行征信报告\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 20,\n" +            "                       \"datumName\": \"林权证\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 21,\n" +            "                       \"datumName\": \"婚姻证明\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 79,\n" +            "                       \"datumName\": \"电子借条\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 1,\n" +            "                       \"datumName\": \"本人身份证\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 2,\n" +            "                       \"datumName\": \"家属身份证\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 3,\n" +            "                       \"datumName\": \"户口本\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 4,\n" +            "                       \"datumName\": \"结婚证\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 10,\n" +            "                       \"datumName\": \"个人社保\"\n" +            "                   }\n" +            "               ],\n" +            "               \"id\": 90946,\n" +            "               \"idcard\": \"330104198003234114\",\n" +            "               \"realname\": \"借入者二\",\n" +            "               \"title\": \"普通标普通...\"\n" +            "           },\n" +            "           {\n" +            "               \"borrowtype\": 1,\n" +            "               \"datalist\":\n" +            "               [\n" +            "                   {\n" +            "                       \"datumId\": 17,\n" +            "                       \"datumName\": \"央行征信报告\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 6,\n" +            "                       \"datumName\": \"驾照\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 8,\n" +            "                       \"datumName\": \"行驶证\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 79,\n" +            "                       \"datumName\": \"电子借条\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 1,\n" +            "                       \"datumName\": \"本人身份证\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 3,\n" +            "                       \"datumName\": \"户口本\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 19,\n" +            "                       \"datumName\": \"其它证明\"\n" +            "                   }\n" +            "               ],\n" +            "               \"id\": 90930,\n" +            "               \"idcard\": \"610114199409263825\",\n" +            "               \"realname\": \"密码三\",\n" +            "               \"title\": \"额的借到所...\"\n" +            "           },\n" +            "           {\n" +            "               \"borrowtype\": 14,\n" +            "               \"datalist\":\n" +            "               [\n" +            "                   {\n" +            "                       \"datumId\": 17,\n" +            "                       \"datumName\": \"央行征信报告\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 20,\n" +            "                       \"datumName\": \"林权证\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 21,\n" +            "                       \"datumName\": \"婚姻证明\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 79,\n" +            "                       \"datumName\": \"电子借条\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 1,\n" +            "                       \"datumName\": \"本人身份证\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 2,\n" +            "                       \"datumName\": \"家属身份证\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 3,\n" +            "                       \"datumName\": \"户口本\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 4,\n" +            "                       \"datumName\": \"结婚证\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 10,\n" +            "                       \"datumName\": \"个人社保\"\n" +            "                   }\n" +            "               ],\n" +            "               \"id\": 90926,\n" +            "               \"idcard\": \"110221198308236613\",\n" +            "               \"realname\": \"李志远\",\n" +            "               \"title\": \"测试借款流...\"\n" +            "           },\n" +            "           {\n" +            "               \"borrowtype\": 1,\n" +            "               \"datalist\":\n" +            "               [\n" +            "                   {\n" +            "                       \"datumId\": 17,\n" +            "                       \"datumName\": \"央行征信报告\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 6,\n" +            "                       \"datumName\": \"驾照\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 8,\n" +            "                       \"datumName\": \"行驶证\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 10,\n" +            "                       \"datumName\": \"个人社保\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 12,\n" +            "                       \"datumName\": \"非工资卡银行近3个月流水\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 14,\n" +            "                       \"datumName\": \"营业执照\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 23,\n" +            "                       \"datumName\": \"学历证明\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 24,\n" +            "                       \"datumName\": \"职工社保\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 25,\n" +            "                       \"datumName\": \"农村医疗保险\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 27,\n" +            "                       \"datumName\": \"水电煤气费\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 33,\n" +            "                       \"datumName\": \"机动车登记证\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 34,\n" +            "                       \"datumName\": \"对公账户银行流水\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 35,\n" +            "                       \"datumName\": \"道路运输证\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 38,\n" +            "                       \"datumName\": \"项目承包合同\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 79,\n" +            "                       \"datumName\": \"电子借条\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 4,\n" +            "                       \"datumName\": \"结婚证\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 5,\n" +            "                       \"datumName\": \"与直系亲属合影照\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 11,\n" +            "                       \"datumName\": \"工资卡银行近3个月流水\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 13,\n" +            "                       \"datumName\": \"现就职单位劳动合同\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 15,\n" +            "                       \"datumName\": \"固定电话近3个月详单\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 18,\n" +            "                       \"datumName\": \"住处相关照片\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 19,\n" +            "                       \"datumName\": \"其它证明\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 21,\n" +            "                       \"datumName\": \"婚姻证明\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 31,\n" +            "                       \"datumName\": \"收入证明\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 45,\n" +            "                       \"datumName\": \"房产证明\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 50,\n" +            "                       \"datumName\": \"家访记录\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 3,\n" +            "                       \"datumName\": \"户口本\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 1,\n" +            "                       \"datumName\": \"本人身份证\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 2,\n" +            "                       \"datumName\": \"家属身份证\"\n" +            "                   }\n" +            "               ],\n" +            "               \"id\": 90917,\n" +            "               \"idcard\": null,\n" +            "               \"realname\": \"借入者测试\",\n" +            "               \"title\": \"测试上传资...\"\n" +            "           },\n" +            "           {\n" +            "               \"borrowtype\": 1,\n" +            "               \"datalist\":\n" +            "               [\n" +            "                   {\n" +            "                       \"datumId\": 17,\n" +            "                       \"datumName\": \"央行征信报告\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 20,\n" +            "                       \"datumName\": \"林权证\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 21,\n" +            "                       \"datumName\": \"婚姻证明\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 79,\n" +            "                       \"datumName\": \"电子借条\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 1,\n" +            "                       \"datumName\": \"本人身份证\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 2,\n" +            "                       \"datumName\": \"家属身份证\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 3,\n" +            "                       \"datumName\": \"户口本\"\n" +            "                   },\n" +            "                   {\n" +            "                       \"datumId\": 10,\n" +            "                       \"datumName\": \"个人社保\"\n" +            "                   }\n" +            "               ],\n" +            "               \"id\": 90908,\n" +            "               \"idcard\": \"211122199111271343\",\n" +            "               \"realname\": \"田源\",\n" +            "               \"title\": \"集成环境测...\"\n" +            "           }\n" +            "       ],\n" +            "       \"msgNum\": 200,\n" +            "       \"pageinfo\": null,\n" +            "       \"retCode\": false,\n" +            "       \"tip\": null,\n" +            "       \"uploadMsg\": null\n" +            "    }\n" +            "\n";}